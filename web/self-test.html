<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>go-deployd API Self-Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1a1a1a;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }

        h1 {
            color: #4CAF50;
            text-align: center;
            font-size: 2em;
        }

        .auth-section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .auth-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .auth-method {
            background: #242424;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .auth-method h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .token-display {
            background: #242424;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border: 1px solid #333;
            word-break: break-all;
        }

        .token-display h4 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .token-display .token {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #ffd700;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
        }

        .main-tabs {
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            margin-top: 30px;
        }

        .main-tab-buttons {
            display: flex;
            background: #2a2a2a;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #333;
        }

        .main-tab-button {
            background: transparent;
            color: #b0b0b0;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-tab-button:hover {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        .main-tab-button.active {
            background: #1a1a1a;
            color: #4CAF50;
            border-bottom: 1px solid #1a1a1a;
        }

        .main-tab-content {
            display: none;
            padding: 25px;
        }

        .main-tab-content.active {
            display: block;
        }

        .request-section {
            background: #242424;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .request-section h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .method-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .method-button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
            background: #2a2a2a;
            border: 1px solid #444;
        }

        .method-button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .response-section {
            background: #242424;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .response-section h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .response-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #444;
            font-size: 0.9em;
        }

        .tab-button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .response-content {
            background: #242424;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #333;
            min-height: 400px;
            overflow: auto;
        }

        .response-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        .status-line {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #242424;
            border-radius: 4px;
        }

        .status-code {
            font-weight: bold;
            font-size: 1.1em;
        }

        .status-code.success { color: #4CAF50; }
        .status-code.error { color: #f44336; }

        .status-text {
            color: #b0b0b0;
        }

        .json-key { color: #9CDCFE; }
        .json-string { color: #CE9178; }
        .json-number { color: #B5CEA8; }
        .json-boolean { color: #569CD6; }
        .json-null { color: #569CD6; }

        .header-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .header-name {
            color: #9CDCFE;
            font-weight: bold;
        }

        .header-value {
            color: #CE9178;
            margin-left: 10px;
        }

        .loading {
            text-align: center;
            color: #4CAF50;
            padding: 20px;
        }

        .error-message {
            background: #3a1a1a;
            border: 1px solid #f44336;
            color: #f44336;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }


        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .auth-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                <img src="/_dashboard/deployd-logo.png" alt="deployd" style="width: 80px; height: 80px;">
                <h1>go-deployd API Self-Test</h1>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Authentication Section -->
        <div class="auth-section">
            <h2>üîê Authentication</h2>
            <div class="auth-grid">
                <!-- Master Key Auth -->
                <div class="auth-method">
                    <h3>Master Key Authentication</h3>
                    <div class="form-group">
                        <label for="masterKey">Master Key</label>
                        <input type="password" id="masterKey" placeholder="Enter master key">
                    </div>
                    <button onclick="loginWithMasterKey()">Login with Master Key</button>
                </div>

                <!-- User/Password Auth -->
                <div class="auth-method">
                    <h3>User Authentication</h3>
                    <div class="form-group">
                        <label for="username">Username/Email</label>
                        <input type="text" id="username" placeholder="Enter username or email">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter password">
                    </div>
                    <button onclick="loginWithCredentials()">Login with Credentials</button>
                </div>
            </div>

            <!-- Token Display -->
            <div id="tokenDisplay" class="token-display" style="display: none;">
                <h4>JWT Token:</h4>
                <div class="token" id="jwtToken"></div>
                <div style="margin-top: 10px;">
                    <button onclick="copyToken()">Copy Token</button>
                    <button onclick="logout()" style="background: #f44336;">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Tabbed Interface -->
        <div class="main-tabs">
            <div class="main-tab-buttons">
                <button class="main-tab-button active" onclick="selectMainTab('api')">
                    üì§ API Testing
                </button>
                <button class="main-tab-button" onclick="selectMainTab('websocket')">
                    üîå WebSocket
                </button>
                <button class="main-tab-button" onclick="selectMainTab('dpdjs')">
                    üöÄ dpd.js Editor
                </button>
                <button class="main-tab-button" onclick="selectMainTab('performance')">
                    ‚ö° Performance
                </button>
            </div>

            <!-- API Testing Tab -->
            <div id="apiTab" class="main-tab-content active">
                <div class="main-grid">
            <!-- Request Section -->
            <div class="request-section">
                <h2>üì§ Request</h2>
                
                <!-- Method Selection -->
                <div class="method-buttons">
                    <button class="method-button active" onclick="selectMethod('GET')">GET</button>
                    <button class="method-button" onclick="selectMethod('POST')">POST</button>
                    <button class="method-button" onclick="selectMethod('PUT')">PUT</button>
                    <button class="method-button" onclick="selectMethod('DELETE')">DELETE</button>
                </div>


                <!-- Quick Endpoints -->
                <div class="form-group">
                    <label>Quick Endpoints</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <button onclick="setEndpoint('/collections')" style="padding: 8px; font-size: 0.9em;">List Collections</button>
                        <button onclick="setEndpoint('/_admin/info')" style="padding: 8px; font-size: 0.9em;">Server Info</button>
                        <button onclick="setEndpoint('/users')" style="padding: 8px; font-size: 0.9em;">Users Collection</button>
                        <button onclick="setEndpoint('/users/count')" style="padding: 8px; font-size: 0.9em;">Users Count</button>
                    </div>
                </div>

                <!-- Endpoint -->
                <div class="form-group">
                    <label for="endpoint">Endpoint</label>
                    <input type="text" id="endpoint" placeholder="/collection/id">
                </div>

                <!-- Query Parameters -->
                <div class="form-group">
                    <label for="queryParams">Query Parameters (JSON)</label>
                    <textarea id="queryParams" rows="3" placeholder='{"$limit": 10, "$sort": {"createdAt": -1}}'></textarea>
                </div>

                <!-- Request Body -->
                <div class="form-group" id="requestBodyGroup" style="display: none;">
                    <label for="requestBody">Request Body (JSON)</label>
                    <textarea id="requestBody" rows="8" placeholder='{"field": "value"}'></textarea>
                </div>

                <!-- Additional Headers -->
                <div class="form-group">
                    <label for="additionalHeaders">Additional Headers (JSON)</label>
                    <textarea id="additionalHeaders" rows="3" placeholder='{"X-Custom-Header": "value"}'></textarea>
                </div>

                <!-- Send Button -->
                <button onclick="sendRequest()" style="width: 100%; margin-top: 20px;">
                    Send Request
                </button>
            </div>

            <!-- Response Section -->
            <div class="response-section">
                <h2>üì• Response</h2>

                <!-- Response Tabs -->
                <div class="response-tabs">
                    <button class="tab-button active" onclick="selectTab('body')">Body</button>
                    <button class="tab-button" onclick="selectTab('headers')">Headers</button>
                    <button class="tab-button" onclick="selectTab('raw')">Raw</button>
                </div>

                <!-- Status Line -->
                <div id="statusLine" class="status-line" style="display: none;">
                    <span class="status-code" id="statusCode"></span>
                    <span class="status-text" id="statusText"></span>
                    <span id="responseTime" style="color: #b0b0b0;"></span>
                </div>

                <!-- Response Content -->
                <div class="response-content">
                    <div id="responseBody" style="display: block;">
                        <pre id="responseBodyContent">Send a request to see the response...</pre>
                    </div>
                    <div id="responseHeaders" style="display: none;">
                        <div id="responseHeadersContent"></div>
                    </div>
                    <div id="responseRaw" style="display: none;">
                        <pre id="responseRawContent"></pre>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- WebSocket Tab -->
            <div id="websocketTab" class="main-tab-content">
                <h2 style="color: #4CAF50; margin-bottom: 20px;">üîå WebSocket Connection</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Connection Controls -->
                <div>
                    <div class="form-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost:2403/socket.io/" placeholder="ws://localhost:2403/socket.io/">
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="connectWebSocket()" id="connectBtn" style="background: #4CAF50;">Connect</button>
                        <button onclick="disconnectWebSocket()" id="disconnectBtn" style="background: #f44336;" disabled>Disconnect</button>
                    </div>
                    <div class="form-group">
                        <label>Room to Join (optional)</label>
                        <input type="text" id="roomName" placeholder="collection:todos">
                        <button onclick="joinRoom()" style="margin-top: 5px; width: 100%;">Join Room</button>
                    </div>
                    <div class="form-group">
                        <label>Event Name</label>
                        <input type="text" id="eventName" placeholder="test-event" value="test-event">
                    </div>
                    <div class="form-group">
                        <label>Event Data (JSON)</label>
                        <textarea id="eventData" rows="3" placeholder='{"message": "Hello WebSocket!"}'>{"message": "Hello WebSocket!"}</textarea>
                    </div>
                    <button onclick="sendEvent()" style="width: 100%;">Send Event</button>
                </div>
                
                <!-- Connection Status & Messages -->
                <div>
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">Connection Status</h4>
                        <div id="wsStatus" style="padding: 10px; background: #2a2a2a; border-radius: 4px; color: #f44336;">Disconnected</div>
                    </div>
                    <div>
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">Messages</h4>
                        <div id="wsMessages" style="height: 200px; overflow-y: auto; background: #2a2a2a; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 0.8em; line-height: 1.4;">
                            <div style="color: #666;">No messages yet...</div>
                        </div>
                        <button onclick="clearMessages()" style="margin-top: 10px; width: 100%; background: #666;">Clear Messages</button>
                    </div>
                </div>
            </div>
            </div>

            <!-- dpd.js Editor Tab -->
            <div id="dpdjsTab" class="main-tab-content">
                <h2 style="color: #4CAF50; margin-bottom: 20px;">üöÄ dpd.js Code Editor</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 500px;">
                <!-- Code Editor -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #4CAF50; margin: 0;">JavaScript Code</h4>
                        <div style="display: flex; gap: 10px;">
                            <select onchange="insertDpdExample(this.value)" style="padding: 5px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 3px;">
                                <option value="">Load Example...</option>
                                <option value="get">Get Documents</option>
                                <option value="create">Create Document</option>
                                <option value="update">Update Document</option>
                                <option value="delete">Delete Document</option>
                                <option value="realtime">Real-time Events</option>
                                <option value="auth-masterkey">Auth: Master Key</option>
                                <option value="auth-userpass">Auth: Username/Password</option>
                            </select>
                            <button onclick="runDpdCode()" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Run Code</button>
                        </div>
                    </div>
                    <div id="dpdCodeEditor" style="height: 400px; border: 1px solid #444; border-radius: 4px;"></div>
                    <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                        üí° The <code>dpd</code> instance is available globally. Use <code>logOutput(message)</code> to display results.
                    </div>
                </div>
                
                <!-- Output Panel -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #4CAF50; margin: 0;">Output</h4>
                        <button onclick="clearDpdOutput()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Clear</button>
                    </div>
                    <div id="dpdOutput" style="height: 400px; overflow-y: auto; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; padding: 15px; font-family: monospace; font-size: 0.9em; line-height: 1.4;">
                        <div style="color: #666;">Run some dpd.js code to see output...</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                        ‚ÑπÔ∏è Real-time events will appear here automatically. Check browser console for detailed logs.
                    </div>
                </div>
            </div>
            </div>

            <!-- Performance Testing Tab -->
            <div id="performanceTab" class="main-tab-content">
                <h2 style="color: #4CAF50; margin-bottom: 20px;">‚ö° Performance & Load Testing</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- WebSocket Stress Test -->
                    <div style="background: #242424; padding: 20px; border-radius: 8px; border: 1px solid #333;">
                        <h3 style="color: #4CAF50; margin-bottom: 15px;">üî• WebSocket Stress Test</h3>
                        <div class="form-group">
                            <label>Concurrent Connections</label>
                            <input type="number" id="stressConnections" value="100" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label>Messages per Second</label>
                            <input type="number" id="stressMessagesPerSec" value="10" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label>Duration (seconds)</label>
                            <input type="number" id="stressDuration" value="30" min="5" max="300">
                        </div>
                        <button onclick="startStressTest()" id="stressTestBtn" style="width: 100%; margin-bottom: 10px;">Start Stress Test</button>
                        <button onclick="stopStressTest()" id="stopStressBtn" style="width: 100%; background: #f44336;" disabled>Stop Test</button>
                        
                        <div id="stressResults" style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 4px; min-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- API Performance Test -->
                    <div style="background: #242424; padding: 20px; border-radius: 8px; border: 1px solid #333;">
                        <h3 style="color: #4CAF50; margin-bottom: 15px;">üöÄ API Performance Test</h3>
                        <div class="form-group">
                            <label>Endpoint</label>
                            <input type="text" id="perfEndpoint" value="/todo-go" placeholder="/endpoint">
                        </div>
                        <div class="form-group">
                            <label>Concurrent Requests</label>
                            <input type="number" id="perfConcurrency" value="10" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>Total Requests</label>
                            <input type="number" id="perfTotal" value="100" min="10" max="10000">
                        </div>
                        <div class="form-group">
                            <label>Request Method</label>
                            <select id="perfMethod">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <button onclick="startAPIPerformanceTest()" id="apiPerfBtn" style="width: 100%; margin-bottom: 10px;">Start API Test</button>
                        
                        <div id="apiPerfResults" style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 4px; min-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <!-- Performance Charts -->
                <div style="margin-top: 20px; background: #242424; padding: 20px; border-radius: 8px; border: 1px solid #333;">
                    <h3 style="color: #4CAF50; margin-bottom: 15px;">üìà Performance Metrics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="color: #4CAF50; font-size: 2em; font-weight: bold;" id="metricLatency">-</div>
                            <div style="color: #b0b0b0; font-size: 0.9em;">Avg Latency (ms)</div>
                        </div>
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="color: #2196F3; font-size: 2em; font-weight: bold;" id="metricThroughput">-</div>
                            <div style="color: #b0b0b0; font-size: 0.9em;">Requests/sec</div>
                        </div>
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="color: #ff9800; font-size: 2em; font-weight: bold;" id="metricErrors">-</div>
                            <div style="color: #b0b0b0; font-size: 0.9em;">Error Rate (%)</div>
                        </div>
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="color: #9c27b0; font-size: 2em; font-weight: bold;" id="metricConnections">-</div>
                            <div style="color: #b0b0b0; font-size: 0.9em;">Active Connections</div>
                        </div>
                    </div>
                    <div id="performanceChart" style="height: 300px; background: #2a2a2a; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #666;">Performance charts will appear here during testing</div>
                </div>
            </div>

        </div>

        <!-- Request History Section -->
        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border: 1px solid #333; margin-top: 30px;">
            <h2 style="color: #4CAF50; margin-bottom: 20px;">üìã Request History</h2>
            <div id="requestHistory" style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: #e0e0e0; font-size: 0.9em;">
                    <thead>
                        <tr style="border-bottom: 1px solid #333;">
                            <th style="padding: 10px; text-align: left; color: #4CAF50;">Time</th>
                            <th style="padding: 10px; text-align: left; color: #4CAF50;">Method</th>
                            <th style="padding: 10px; text-align: left; color: #4CAF50;">Endpoint</th>
                            <th style="padding: 10px; text-align: left; color: #4CAF50;">Status</th>
                            <th style="padding: 10px; text-align: left; color: #4CAF50;">Time</th>
                            <th style="padding: 10px; text-align: left; color: #4CAF50;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: #666;">No requests yet...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button onclick="clearHistory()" style="background: #f44336; padding: 8px 16px; font-size: 0.9em;">Clear History</button>
            </div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentMethod = 'GET';
        let currentTab = 'body';
        let currentMainTab = 'api';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check for stored token
            const storedToken = localStorage.getItem('deployd-jwt');
            if (storedToken) {
                currentToken = storedToken;
                displayToken(storedToken);
            }
            
            // Load collections
            loadCollections();
            
            // Load request history
            loadRequestHistory();
        });

        // Main Tab Functions
        function selectMainTab(tabName) {
            // Hide all tab contents
            const tabs = ['api', 'websocket', 'dpdjs', 'performance'];
            tabs.forEach(tab => {
                const tabContent = document.getElementById(tab + 'Tab');
                const tabButton = document.querySelector(`[onclick="selectMainTab('${tab}')"]`);
                
                if (tabContent) tabContent.classList.remove('active');
                if (tabButton) tabButton.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            const selectedButton = document.querySelector(`[onclick="selectMainTab('${tabName}')"]`);
            
            if (selectedTab) selectedTab.classList.add('active');
            if (selectedButton) selectedButton.classList.add('active');
            
            currentMainTab = tabName;
            
            // Trigger Monaco editor resize if switching to dpd.js tab
            if (tabName === 'dpdjs' && window.dpdEditor) {
                setTimeout(() => {
                    window.dpdEditor.layout();
                }, 100);
            }
        }

        // Authentication Functions
        async function loginWithMasterKey() {
            const masterKey = document.getElementById('masterKey').value;
            
            if (!masterKey) {
                showError('Please enter a master key');
                return;
            }

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ masterKey })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('deployd-jwt', data.token);
                    displayToken(data.token);
                    loadCollections();
                } else {
                    showError(data.message || 'Login failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        async function loginWithCredentials() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showError('Please enter username and password');
                return;
            }

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('deployd-jwt', data.token);
                    displayToken(data.token);
                    loadCollections();
                } else {
                    showError(data.message || 'Login failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function displayToken(token) {
            document.getElementById('tokenDisplay').style.display = 'block';
            document.getElementById('jwtToken').textContent = token;
        }

        function copyToken() {
            navigator.clipboard.writeText(currentToken);
            alert('Token copied to clipboard!');
        }

        function logout() {
            currentToken = null;
            localStorage.removeItem('deployd-jwt');
            document.getElementById('tokenDisplay').style.display = 'none';
            document.getElementById('masterKey').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Collection Loading
        async function loadCollections() {
            try {
                const headers = {};
                if (currentToken) {
                    headers['Authorization'] = `Bearer ${currentToken}`;
                }

            } catch (error) {
                console.error('Failed to load collections:', error);
            }
        }

        // Method Selection
        function selectMethod(method) {
            currentMethod = method;
            
            // Update button states
            document.querySelectorAll('.method-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide request body
            const bodyGroup = document.getElementById('requestBodyGroup');
            if (method === 'POST' || method === 'PUT') {
                bodyGroup.style.display = 'block';
            } else {
                bodyGroup.style.display = 'none';
            }
            
            updateEndpoint();
        }

        // Tab Selection
        function selectTab(tab) {
            currentTab = tab;
            
            // Update button states
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide content
            document.getElementById('responseBody').style.display = tab === 'body' ? 'block' : 'none';
            document.getElementById('responseHeaders').style.display = tab === 'headers' ? 'block' : 'none';
            document.getElementById('responseRaw').style.display = tab === 'raw' ? 'block' : 'none';
        }

        // Set endpoint helper
        function setEndpoint(endpoint) {
            document.getElementById('endpoint').value = endpoint;
        }

        // Send Request
        async function sendRequest() {
            const endpoint = document.getElementById('endpoint').value;
            
            if (!endpoint) {
                showError('Please enter an endpoint');
                return;
            }
            
            // Build URL with query parameters
            let url = endpoint;
            const queryParams = document.getElementById('queryParams').value;
            if (queryParams) {
                try {
                    const params = JSON.parse(queryParams);
                    const queryString = Object.entries(params)
                        .map(([key, value]) => `${key}=${encodeURIComponent(JSON.stringify(value))}`)
                        .join('&');
                    if (queryString) {
                        url += '?' + queryString;
                    }
                } catch (e) {
                    showError('Invalid query parameters JSON');
                    return;
                }
            }
            
            // Build headers
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (currentToken) {
                headers['Authorization'] = `Bearer ${currentToken}`;
            }
            
            const additionalHeaders = document.getElementById('additionalHeaders').value;
            if (additionalHeaders) {
                try {
                    const additional = JSON.parse(additionalHeaders);
                    Object.assign(headers, additional);
                } catch (e) {
                    showError('Invalid additional headers JSON');
                    return;
                }
            }
            
            // Build request options
            const options = {
                method: currentMethod,
                headers
            };
            
            // Add body for POST/PUT
            if (currentMethod === 'POST' || currentMethod === 'PUT') {
                const requestBody = document.getElementById('requestBody').value;
                if (requestBody) {
                    try {
                        JSON.parse(requestBody); // Validate JSON
                        options.body = requestBody;
                    } catch (e) {
                        showError('Invalid request body JSON');
                        return;
                    }
                }
            }
            
            // Show loading
            document.getElementById('responseBodyContent').textContent = 'Loading...';
            document.getElementById('statusLine').style.display = 'none';
            
            // Start timer
            const startTime = performance.now();
            
            try {
                const response = await fetch(url, options);
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                // Update status line
                const statusLine = document.getElementById('statusLine');
                statusLine.style.display = 'flex';
                
                const statusCode = document.getElementById('statusCode');
                statusCode.textContent = response.status;
                statusCode.className = response.ok ? 'status-code success' : 'status-code error';
                
                document.getElementById('statusText').textContent = response.statusText;
                document.getElementById('responseTime').textContent = `${responseTime}ms`;
                
                // Get response text
                const responseText = await response.text();
                
                // Update headers
                const headersHtml = [];
                for (const [name, value] of response.headers) {
                    headersHtml.push(`
                        <div class="header-item">
                            <span class="header-name">${escapeHtml(name)}:</span>
                            <span class="header-value">${escapeHtml(value)}</span>
                        </div>
                    `);
                }
                document.getElementById('responseHeadersContent').innerHTML = headersHtml.join('');
                
                // Update raw response
                document.getElementById('responseRawContent').textContent = responseText;
                
                // Update body (with JSON formatting if applicable)
                try {
                    const jsonData = JSON.parse(responseText);
                    document.getElementById('responseBodyContent').innerHTML = syntaxHighlight(jsonData);
                } catch (e) {
                    // Not JSON, display as text
                    document.getElementById('responseBodyContent').textContent = responseText;
                }
                
                // Save successful request to history
                const requestBody = document.getElementById('requestBody').value;
                saveRequestToHistory({
                    method: currentMethod,
                    endpoint: endpoint,
                    queryParams: queryParams,
                    requestBody: currentMethod === 'POST' || currentMethod === 'PUT' ? requestBody : null,
                    additionalHeaders: additionalHeaders,
                    status: response.status,
                    statusText: response.statusText,
                    responseTime: responseTime,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                showError('Request failed: ' + error.message);
                document.getElementById('responseBodyContent').textContent = 'Error: ' + error.message;
                
                // Still save the failed request to history
                saveRequestToHistory({
                    method: currentMethod,
                    endpoint: endpoint,
                    queryParams: queryParams,
                    requestBody: currentMethod === 'POST' || currentMethod === 'PUT' ? requestBody : null,
                    additionalHeaders: additionalHeaders,
                    status: 'Error',
                    statusText: error.message,
                    responseTime: 0,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // Utility Functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            // Find a suitable place to show the error
            const authSection = document.querySelector('.auth-section');
            authSection.appendChild(errorDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function syntaxHighlight(json) {
            const jsonStr = JSON.stringify(json, null, 2);
            return jsonStr.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Request History Functions
        function saveRequestToHistory(requestData) {
            let history = JSON.parse(localStorage.getItem('deployd-request-history') || '[]');
            
            // Add timestamp if not present
            if (!requestData.timestamp) {
                requestData.timestamp = new Date().toISOString();
            }
            
            // Add to beginning of array
            history.unshift(requestData);
            
            // Keep only last 20 requests
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            // Save back to localStorage
            localStorage.setItem('deployd-request-history', JSON.stringify(history));
            
            // Update the display
            updateHistoryDisplay();
        }

        function loadRequestHistory() {
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('deployd-request-history') || '[]');
            const tbody = document.getElementById('historyTableBody');
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;">No requests yet...</td></tr>';
                return;
            }
            
            tbody.innerHTML = history.map((req, index) => {
                const time = new Date(req.timestamp).toLocaleTimeString();
                const statusClass = req.status === 'Error' || req.status >= 400 ? 'error' : 'success';
                const statusText = req.status === 'Error' ? 'ERROR' : req.status;
                
                return `
                    <tr style="border-bottom: 1px solid #333; cursor: pointer;" onmouseover="this.style.backgroundColor='#2a2a2a'" onmouseout="this.style.backgroundColor='transparent'" onclick="loadRequestFromHistory(${index})">
                        <td style="padding: 8px;">${time}</td>
                        <td style="padding: 8px;"><span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${req.method}</span></td>
                        <td style="padding: 8px; font-family: monospace;">${req.endpoint}</td>
                        <td style="padding: 8px;"><span class="status-code ${statusClass}" style="font-size: 0.9em;">${statusText}</span></td>
                        <td style="padding: 8px; color: #b0b0b0;">${req.responseTime}ms</td>
                        <td style="padding: 8px;">
                            <button onclick="loadRequestFromHistory(${index}); event.stopPropagation();" style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 0.8em; cursor: pointer;">Use</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadRequestFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('deployd-request-history') || '[]');
            const req = history[index];
            
            if (!req) return;
            
            // Set method
            selectMethod(req.method);
            
            // Set endpoint
            document.getElementById('endpoint').value = req.endpoint;
            
            // Set query parameters
            document.getElementById('queryParams').value = req.queryParams || '';
            
            // Set request body if applicable
            if (req.requestBody && (req.method === 'POST' || req.method === 'PUT')) {
                document.getElementById('requestBody').value = req.requestBody;
            }
            
            // Set additional headers
            document.getElementById('additionalHeaders').value = req.additionalHeaders || '';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear the request history?')) {
                localStorage.removeItem('deployd-request-history');
                updateHistoryDisplay();
            }
        }

        // WebSocket Functions
        let ws = null;
        let wsConnected = false;

        function connectWebSocket() {
            const wsUrl = document.getElementById('wsUrl').value;
            if (!wsUrl) {
                showError('Please enter WebSocket URL');
                return;
            }

            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    wsConnected = true;
                    updateConnectionStatus('Connected', '#4CAF50');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    addMessage('Connected to WebSocket', 'info');
                    
                    // Authenticate if we have a token
                    if (currentToken) {
                        sendWebSocketMessage({
                            type: 'auth',
                            token: currentToken
                        });
                    }
                };

                ws.onclose = function(event) {
                    wsConnected = false;
                    updateConnectionStatus('Disconnected', '#f44336');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    addMessage(`Disconnected: ${event.code} ${event.reason}`, 'warning');
                };

                ws.onerror = function(error) {
                    addMessage(`WebSocket error: ${error}`, 'error');
                };

                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        addMessage(`Received: ${JSON.stringify(message, null, 2)}`, 'received');
                        
                        // üìä Track real message for dashboard metrics
                        trackMessage();
                    } catch (e) {
                        addMessage(`Received (raw): ${event.data}`, 'received');
                        
                        // üìä Track real message for dashboard metrics
                        trackMessage();
                    }
                };

            } catch (error) {
                showError('Failed to connect: ' + error.message);
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }

        function sendWebSocketMessage(message) {
            if (!ws || !wsConnected) {
                showError('WebSocket not connected');
                return;
            }

            try {
                const messageStr = JSON.stringify(message);
                ws.send(messageStr);
                addMessage(`Sent: ${JSON.stringify(message, null, 2)}`, 'sent');
                
                // üìä Track real message for dashboard metrics
                trackMessage();
            } catch (error) {
                showError('Failed to send message: ' + error.message);
            }
        }

        function joinRoom() {
            const roomName = document.getElementById('roomName').value;
            if (!roomName) {
                showError('Please enter room name');
                return;
            }

            sendWebSocketMessage({
                type: 'join',
                room: roomName
            });
        }

        function sendEvent() {
            const eventName = document.getElementById('eventName').value;
            const eventDataStr = document.getElementById('eventData').value;
            
            if (!eventName) {
                showError('Please enter event name');
                return;
            }

            let eventData;
            try {
                eventData = eventDataStr ? JSON.parse(eventDataStr) : {};
            } catch (error) {
                showError('Invalid event data JSON');
                return;
            }

            const roomName = document.getElementById('roomName').value;
            const message = {
                type: 'emit',
                event: eventName,
                data: eventData
            };

            if (roomName) {
                message.room = roomName;
            }

            sendWebSocketMessage(message);
        }

        function updateConnectionStatus(status, color) {
            const statusElement = document.getElementById('wsStatus');
            statusElement.textContent = status;
            statusElement.style.color = color;
        }

        function addMessage(message, type) {
            const messagesContainer = document.getElementById('wsMessages');
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '5px';
            messageDiv.style.padding = '5px';
            messageDiv.style.borderRadius = '3px';
            
            const timestamp = new Date().toLocaleTimeString();
            
            switch (type) {
                case 'info':
                    messageDiv.style.color = '#4CAF50';
                    break;
                case 'warning':
                    messageDiv.style.color = '#ff9800';
                    break;
                case 'error':
                    messageDiv.style.color = '#f44336';
                    break;
                case 'sent':
                    messageDiv.style.color = '#2196F3';
                    messageDiv.style.backgroundColor = '#1a2332';
                    break;
                case 'received':
                    messageDiv.style.color = '#4CAF50';
                    messageDiv.style.backgroundColor = '#1a321a';
                    break;
                default:
                    messageDiv.style.color = '#e0e0e0';
            }
            
            messageDiv.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            
            // Remove placeholder message
            if (messagesContainer.children.length === 1 && messagesContainer.children[0].style.color === 'rgb(102, 102, 102)') {
                messagesContainer.innerHTML = '';
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function clearMessages() {
            const messagesContainer = document.getElementById('wsMessages');
            messagesContainer.innerHTML = '<div style="color: #666;">No messages yet...</div>';
        }
        
        // üöÄ KICK-ASS PERFORMANCE TESTING FUNCTIONS
        let stressTestConnections = [];
        let stressTestActive = false;
        let performanceMetrics = { latency: [], errors: 0 };

        function startStressTest() {
            const connections = parseInt(document.getElementById('stressConnections').value);
            const messagesPerSec = parseInt(document.getElementById('stressMessagesPerSec').value);
            const duration = parseInt(document.getElementById('stressDuration').value);
            
            stressTestActive = true;
            document.getElementById('stressTestBtn').disabled = true;
            document.getElementById('stopStressBtn').disabled = false;
            
            const resultsDiv = document.getElementById('stressResults');
            resultsDiv.innerHTML = '<div style="color: #4CAF50;">üöÄ Starting stress test...</div>';
            
            performanceMetrics = { latency: [], errors: 0 };
            
            for (let i = 0; i < connections; i++) {
                setTimeout(() => {
                    if (!stressTestActive) return;
                    createStressTestConnection(i, messagesPerSec);
                }, i * 10);
            }
            
            setTimeout(() => {
                if (stressTestActive) stopStressTest();
            }, duration * 1000);
        }

        function createStressTestConnection(connectionId, messagesPerSec) {
            try {
                const ws = new WebSocket('ws://localhost:2403/socket.io/');
                let messageCount = 0;
                
                ws.onopen = function() {
                    stressTestConnections.push(ws);
                    updateStressResults(`‚úÖ Connection ${connectionId} established`);
                    
                    const messageInterval = setInterval(() => {
                        if (!stressTestActive || ws.readyState !== WebSocket.OPEN) {
                            clearInterval(messageInterval);
                            return;
                        }
                        
                        const startTime = performance.now();
                        ws.send(JSON.stringify({
                            type: 'emit',
                            event: 'stress-test',
                            data: { connectionId, messageId: messageCount++, timestamp: Date.now() }
                        }));
                        
                        const latency = performance.now() - startTime;
                        performanceMetrics.latency.push(latency);
                        updatePerformanceMetrics();
                        
                        // üìä Track stress test messages
                        trackMessage();
                    }, 1000 / messagesPerSec);
                };
                
                ws.onclose = () => updateStressResults(`‚ùå Connection ${connectionId} closed`);
                ws.onerror = () => {
                    performanceMetrics.errors++;
                    updateStressResults(`‚ö†Ô∏è Connection ${connectionId} error`);
                };
                
            } catch (error) {
                updateStressResults(`üí• Failed to create connection ${connectionId}: ${error.message}`);
            }
        }

        function stopStressTest() {
            stressTestActive = false;
            document.getElementById('stressTestBtn').disabled = false;
            document.getElementById('stopStressBtn').disabled = true;
            
            stressTestConnections.forEach(ws => {
                if (ws.readyState === WebSocket.OPEN) ws.close();
            });
            stressTestConnections = [];
            
            updateStressResults('üèÅ Stress test completed');
            generateStressReport();
        }

        function updateStressResults(message) {
            const resultsDiv = document.getElementById('stressResults');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `<div style="margin-bottom: 3px; color: #e0e0e0; font-size: 0.85em;">[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function generateStressReport() {
            const avgLatency = performanceMetrics.latency.length > 0 
                ? (performanceMetrics.latency.reduce((a, b) => a + b, 0) / performanceMetrics.latency.length).toFixed(2) : 0;
            const maxLatency = performanceMetrics.latency.length > 0 ? Math.max(...performanceMetrics.latency).toFixed(2) : 0;
                
            const report = `
                <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #4CAF50;">
                    <h4 style="color: #4CAF50; margin-bottom: 10px;">üî• Stress Test Report</h4>
                    <div style="color: #e0e0e0; line-height: 1.6;">
                        <div>üìä Messages Sent: ${performanceMetrics.latency.length}</div>
                        <div>‚ö° Average Latency: ${avgLatency}ms</div>
                        <div>üèéÔ∏è Max Latency: ${maxLatency}ms</div>
                        <div>‚ùå Errors: ${performanceMetrics.errors}</div>
                        <div>‚úÖ Success Rate: ${((1 - performanceMetrics.errors / Math.max(1, performanceMetrics.latency.length)) * 100).toFixed(1)}%</div>
                    </div>
                </div>`;
            
            document.getElementById('stressResults').innerHTML += report;
        }

        function updatePerformanceMetrics() {
            if (performanceMetrics.latency.length > 0) {
                const avgLatency = (performanceMetrics.latency.reduce((a, b) => a + b, 0) / performanceMetrics.latency.length).toFixed(1);
                document.getElementById('metricLatency').textContent = avgLatency;
                document.getElementById('metricThroughput').textContent = performanceMetrics.latency.length;
                document.getElementById('metricErrors').textContent = ((performanceMetrics.errors / Math.max(1, performanceMetrics.latency.length)) * 100).toFixed(1);
                document.getElementById('metricConnections').textContent = stressTestConnections.length;
            }
        }


        // üéØ API PERFORMANCE TESTING
        async function startAPIPerformanceTest() {
            const endpoint = document.getElementById('perfEndpoint').value;
            const concurrency = parseInt(document.getElementById('perfConcurrency').value);
            const total = parseInt(document.getElementById('perfTotal').value);
            const method = document.getElementById('perfMethod').value;
            
            document.getElementById('apiPerfBtn').disabled = true;
            const resultsDiv = document.getElementById('apiPerfResults');
            resultsDiv.innerHTML = '<div style="color: #4CAF50;">üöÄ Starting API performance test...</div>';
            
            const startTime = Date.now();
            let completed = 0;
            let errors = 0;
            const latencies = [];
            
            const requestsPerWorker = Math.ceil(total / concurrency);
            const workers = [];
            
            for (let i = 0; i < concurrency; i++) {
                workers.push(runAPIWorker(endpoint, method, requestsPerWorker, (latency, error) => {
                    completed++;
                    if (error) errors++;
                    else latencies.push(latency);
                    
                    if (completed >= total) {
                        const duration = Date.now() - startTime;
                        generateAPIReport(duration, latencies, errors, total);
                        document.getElementById('apiPerfBtn').disabled = false;
                    }
                }));
            }
        }

        async function runAPIWorker(endpoint, method, requests, callback) {
            for (let i = 0; i < requests; i++) {
                try {
                    const startTime = performance.now();
                    
                    const options = { method };
                    if (currentToken) {
                        options.headers = { 'Authorization': `Bearer ${currentToken}` };
                    }
                    
                    const response = await fetch(endpoint, options);
                    const latency = performance.now() - startTime;
                    
                    callback(latency, !response.ok);
                } catch (error) {
                    callback(0, true);
                }
            }
        }

        function generateAPIReport(duration, latencies, errors, total) {
            const avgLatency = latencies.length > 0 
                ? (latencies.reduce((a, b) => a + b, 0) / latencies.length).toFixed(2) : 0;
            const throughput = ((total - errors) / (duration / 1000)).toFixed(1);
            const errorRate = ((errors / total) * 100).toFixed(1);
            
            const report = `
                <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #2196F3;">
                    <h4 style="color: #2196F3; margin-bottom: 10px;">üéØ API Performance Report</h4>
                    <div style="color: #e0e0e0; line-height: 1.6;">
                        <div>üìä Total Requests: ${total}</div>
                        <div>‚è±Ô∏è Duration: ${(duration / 1000).toFixed(1)}s</div>
                        <div>üöÄ Throughput: ${throughput} req/s</div>
                        <div>‚ö° Average Latency: ${avgLatency}ms</div>
                        <div>‚ùå Errors: ${errors}</div>
                        <div>üìà Success Rate: ${(100 - parseFloat(errorRate)).toFixed(1)}%</div>
                    </div>
                </div>`;
            
            document.getElementById('apiPerfResults').innerHTML += report;
        }
    </script>

    <!-- Load dpd.js -->
    <script src="/dpd.js"></script>
    <!-- Load Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.50.0/min/vs/loader.js"></script>
    <script>
        let dpdEditor;
        let dpdInstance;

        // Initialize dpd.js instance
        document.addEventListener('DOMContentLoaded', function() {
            // The dpd.js library automatically creates a global dpd instance
            // But let's ensure it's available and create one if needed
            if (!window.dpd) {
                window.dpd = new Deployd();
            }
            dpdInstance = window.dpd;
            console.log('dpd.js initialized:', dpdInstance);
            
            // Wait a moment for WebSocket connection
            setTimeout(() => {
                const output = document.getElementById('dpdOutput');
                if (output) {
                    output.innerHTML += '<div style="color: #4CAF50; margin-bottom: 5px;">dpd.js ready! You can now run the example code.</div>';
                }
            }, 1000);
        });

        // Add global error handler for Monaco keyboard events
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('getModifierState')) {
                console.warn('Monaco keyboard event error suppressed:', e.message);
                e.preventDefault();
                return true;
            }
        });

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.50.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            try {
                dpdEditor = monaco.editor.create(document.getElementById('dpdCodeEditor'), {
                value: `// Test dpd.js functionality
// dpd instance is available globally

// Example 1: Get all todos
dpd['todo-go'].get({}, (err, todos) => {
    if (err) {
        console.error('Error:', err);
        return;
    }
    console.log('Todos:', todos);
    logOutput('Got ' + todos.length + ' todos');
});

// Example 2: Listen for real-time events
dpd['todo-go'].on('created', (todo) => {
    console.log('New todo created:', todo);
    logOutput('Real-time: New todo created - ' + todo.title);
});

dpd['todo-go'].on('updated', (todo) => {
    console.log('Todo updated:', todo);
    logOutput('Real-time: Todo updated - ' + todo.title);
});

dpd['todo-go'].on('deleted', (todo) => {
    console.log('Todo deleted:', todo);
    logOutput('Real-time: Todo deleted - ' + todo.title);
});

// Example 3: Create a new todo
dpd['todo-go'].post({
    title: 'Test from dpd.js',
    completed: false,
    priority: 5
}, (err, result) => {
    if (err) {
        console.error('Error creating todo:', err);
        logOutput('Error: ' + err.message);
        return;
    }
    console.log('Created todo:', result);
    logOutput('Created todo: ' + result.title + ' (ID: ' + result.id + ')');
});

// Helper function to output to the results panel
function logOutput(message) {
    const output = document.getElementById('dpdOutput');
    const timestamp = new Date().toLocaleTimeString();
    output.innerHTML += '<div style="margin-bottom: 5px;"><span style="color: #666;">[' + timestamp + ']</span> ' + message + '</div>';
    output.scrollTop = output.scrollHeight;
}`,
                language: 'javascript',
                theme: 'vs-dark',
                fontSize: 14,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                automaticLayout: true
            });
            } catch (error) {
                console.error('Monaco Editor initialization error:', error);
                document.getElementById('dpdCodeEditor').innerHTML = '<div style="color: #f44336; padding: 20px;">Failed to load Monaco Editor. Please refresh the page.</div>';
            }
        });

        function runDpdCode() {
            const code = dpdEditor.getValue();
            
            // Clear output
            document.getElementById('dpdOutput').innerHTML = '';
            
            // Ensure dpd instance is available
            if (!window.dpd) {
                const output = document.getElementById('dpdOutput');
                output.innerHTML += '<div style="color: #f44336; margin-bottom: 5px;">Error: dpd.js not loaded yet. Please wait and try again.</div>';
                return;
            }
            
            try {
                // Create a function with the code and execute it in global context
                const func = new Function('dpd', 'logOutput', code);
                func(window.dpd, function(message) {
                    const output = document.getElementById('dpdOutput');
                    const timestamp = new Date().toLocaleTimeString();
                    output.innerHTML += '<div style="margin-bottom: 5px;"><span style="color: #666;">[' + timestamp + ']</span> ' + message + '</div>';
                    output.scrollTop = output.scrollHeight;
                });
            } catch (error) {
                const output = document.getElementById('dpdOutput');
                output.innerHTML += '<div style="color: #f44336; margin-bottom: 5px;">Error: ' + error.message + '</div>';
            }
        }

        function clearDpdOutput() {
            document.getElementById('dpdOutput').innerHTML = '';
        }

        function insertDpdExample(example) {
            const examples = {
                get: `// Get documents with query
dpd['todo-go'].get({ completed: false }, (err, todos) => {
    if (err) return logOutput('Error: ' + err.message);
    logOutput('Found ' + todos.length + ' incomplete todos');
    todos.forEach(todo => logOutput('- ' + todo.title));
});`,
                create: `// Create a new document
dpd['todo-go'].post({
    title: 'New task from dpd.js',
    completed: false,
    priority: Math.floor(Math.random() * 10) + 1
}, (err, todo) => {
    if (err) return logOutput('Error: ' + err.message);
    logOutput('Created: ' + todo.title + ' (ID: ' + todo.id + ')');
});`,
                update: `// Update a document (replace ID with actual one)
dpd['todo-go'].put('DOCUMENT_ID_HERE', {
    completed: true,
    priority: 10
}, (err, todo) => {
    if (err) return logOutput('Error: ' + err.message);
    logOutput('Updated: ' + todo.title);
});`,
                delete: `// Delete a document (replace ID with actual one)
dpd['todo-go'].del('DOCUMENT_ID_HERE', (err) => {
    if (err) return logOutput('Error: ' + err.message);
    logOutput('Document deleted successfully');
});`,
                realtime: `// Real-time event listeners
logOutput('üîó Setting up real-time events...');

// Check WebSocket connection status
logOutput('WebSocket Ready: ' + (dpd.socketReady ? 'Yes' : 'No'));

// Set up real-time event listeners (these work even if WebSocket connects later)
dpd['todo-go'].on('created', (todo) => {
    logOutput('üÜï Real-time: Created - ' + todo.title);
});

dpd['todo-go'].on('updated', (todo) => {
    logOutput('üìù Real-time: Updated - ' + todo.title);
});

dpd['todo-go'].on('deleted', (todo) => {
    logOutput('üóëÔ∏è Real-time: Deleted - ' + todo.title);
});

// Listen for WebSocket connection events
dpd.on('connect', () => {
    logOutput('‚úÖ WebSocket connected!');
});

dpd.on('disconnect', () => {
    logOutput('‚ùå WebSocket disconnected');
});

// Manually join collection room to ensure we get events
if (dpd.socketReady) {
    dpd.join('collection:todo-go');
    logOutput('üè† Joined collection:todo-go room');
} else {
    dpd.once('connect', () => {
        dpd.join('collection:todo-go');
        logOutput('üè† Joined collection:todo-go room');
    });
}

logOutput('üëÇ Real-time listeners set up! Try creating/deleting todos in the API tab to see events.');

// Test: Create, update, and delete a todo to trigger real-time events
let testTodoId = null;

setTimeout(() => {
    logOutput('üìù Creating test todo to trigger real-time event...');
    dpd['todo-go'].post({
        title: 'Real-time test todo',
        completed: false,
        priority: 1
    }, (err, result) => {
        if (err) {
            logOutput('‚ùå Failed to create test todo: ' + err.message);
        } else {
            logOutput('‚úÖ Test todo created: ' + result.title);
            testTodoId = result.id;
            
            // Update the todo after 2 seconds
            setTimeout(() => {
                logOutput('üìù Updating test todo to trigger update event...');
                dpd['todo-go'].put(testTodoId, {
                    title: 'Updated real-time test todo',
                    completed: true,
                    priority: 5
                }, (err, updated) => {
                    if (err) {
                        logOutput('‚ùå Failed to update test todo: ' + err.message);
                    } else {
                        logOutput('‚úÖ Test todo updated: ' + updated.title);
                        
                        // Delete the todo after another 2 seconds
                        setTimeout(() => {
                            logOutput('üóëÔ∏è Deleting test todo to trigger delete event...');
                            dpd['todo-go'].del(testTodoId, (err) => {
                                if (err) {
                                    logOutput('‚ùå Failed to delete test todo: ' + err.message);
                                } else {
                                    logOutput('‚úÖ Test todo deleted successfully');
                                    logOutput('üéØ Real-time event demo complete! Check the logs above for all events.');
                                }
                            });
                        }, 2000);
                    }
                });
            }, 2000);
        }
}, 1000);
});
`,
                'auth-masterkey': `// üîë Master Key Authentication Flow
logOutput('üîë Starting Master Key Authentication...');

// Replace 'your-master-key-here' with your actual master key
const masterKey = 'your-master-key-here';

if (!masterKey || masterKey === 'your-master-key-here') {
    logOutput('‚ùå Please replace "your-master-key-here" with your actual master key');
    logOutput('üí° Tip: Check your deployd configuration for the master key');
    return;
}

// Authenticate with master key
dpd.request('POST', '/auth/login', {
    masterKey: masterKey
}, (err, response) => {
    if (err) {
        logOutput('‚ùå Master key authentication failed: ' + err.message);
        logOutput('üí° Check if your master key is correct and the server is running');
        return;
    }
    
    logOutput('‚úÖ Master key authentication successful!');
    logOutput('üë§ Authenticated as: ' + (response.user ? response.user.username || 'Master' : 'Master'));
    logOutput('üé´ JWT Token received: ' + response.token.substring(0, 30) + '...');
    
    // Set the JWT token for all future requests
    dpd.setToken(response.token);
    logOutput('üîí JWT token configured for dpd.js - all requests will now include authentication');
    
    // Test authenticated request
    setTimeout(() => {
        logOutput('üß™ Testing authenticated request...');
        dpd.request('GET', '/_admin/info', (err, info) => {
            if (err) {
                logOutput('‚ùå Admin info request failed: ' + err.message);
            } else {
                logOutput('‚úÖ Admin info retrieved successfully:');
                logOutput('   üìä Collections: ' + (info.collections ? info.collections.length : 'N/A'));
                logOutput('   üèÉ Server: ' + (info.version || 'go-deployd'));
            }
        });
    }, 500);
    
    // Test collection access with authentication
    setTimeout(() => {
        logOutput('üß™ Testing authenticated collection access...');
        dpd['todo-go'].get({}, (err, todos) => {
            if (err) {
                logOutput('‚ùå Collection access failed: ' + err.message);
            } else {
                logOutput('‚úÖ Collection access successful: ' + todos.length + ' todos found');
            }
        });
    }, 1000);
});

logOutput('‚è≥ Attempting master key authentication...');`,

                'auth-userpass': `// üë§ Username/Password Authentication Flow
logOutput('üë§ Starting Username/Password Authentication...');

// Replace these with actual user credentials
const credentials = {
    username: 'admin',  // Replace with actual username/email
    password: 'password123'  // Replace with actual password
};

if (credentials.username === 'admin' && credentials.password === 'password123') {
    logOutput('‚ö†Ô∏è Using default credentials - replace with actual username and password');
    logOutput('üí° Edit the credentials object above with real user data');
}

// Step 1: Login with username and password
logOutput('üîê Attempting login with username: ' + credentials.username);

dpd.request('POST', '/auth/login', credentials, (err, response) => {
    if (err) {
        logOutput('‚ùå Login failed: ' + err.message);
        logOutput('üí° Possible issues:');
        logOutput('   ‚Ä¢ Incorrect username/password');
        logOutput('   ‚Ä¢ User does not exist');
        logOutput('   ‚Ä¢ Authentication not configured');
        return;
    }
    
    logOutput('‚úÖ Login successful!');
    logOutput('üë§ Logged in as: ' + response.user.username);
    logOutput('üìß Email: ' + (response.user.email || 'Not provided'));
    logOutput('üé´ JWT Token: ' + response.token.substring(0, 30) + '...');
    
    // Step 2: Set the JWT token for future requests
    dpd.setToken(response.token);
    logOutput('üîí JWT token configured - all requests will now be authenticated');
    
    // Step 3: Test the authenticated session
    setTimeout(() => {
        logOutput('üß™ Testing authenticated session...');
        dpd.request('GET', '/auth/me', (err, user) => {
            if (err) {
                logOutput('‚ùå Session check failed: ' + err.message);
            } else {
                logOutput('‚úÖ Session verified:');
                logOutput('   üë§ Username: ' + user.username);
                logOutput('   üìß Email: ' + (user.email || 'Not set'));
                logOutput('   üÜî User ID: ' + user.id);
                logOutput('   ‚è∞ Last login: ' + (user.lastLogin || 'Not recorded'));
            }
        });
    }, 500);
    
    // Step 4: Test authenticated collection operations
    setTimeout(() => {
        logOutput('üß™ Testing authenticated collection operations...');
        
        // Try to access a collection that might require authentication
        dpd['todo-go'].get({}, (err, todos) => {
            if (err) {
                logOutput('‚ùå Collection access error: ' + err.message);
            } else {
                logOutput('‚úÖ Collection access successful: ' + todos.length + ' todos retrieved');
                
                // Try to create a todo as the authenticated user
                dpd['todo-go'].post({
                    title: 'Authenticated todo from ' + response.user.username,
                    completed: false,
                    createdBy: response.user.id
                }, (err, newTodo) => {
                    if (err) {
                        logOutput('‚ùå Create todo error: ' + err.message);
                    } else {
                        logOutput('‚úÖ Todo created successfully: ' + newTodo.title);
                        logOutput('   üÜî ID: ' + newTodo.id);
                    }
                });
            }
        });
    }, 1000);
});

// Step 5: Logout function (uncomment to test)
/*
setTimeout(() => {
    logOutput('üö™ Testing logout...');
    dpd.request('POST', '/auth/logout', (err, result) => {
        if (err) {
            logOutput('‚ùå Logout error: ' + err.message);
        } else {
            logOutput('‚úÖ Logged out successfully');
            dpd.setToken(null); // Clear the token
            logOutput('üîì JWT token cleared');
        }
    });
}, 5000);
*/

logOutput('‚è≥ Attempting username/password authentication...');`
            };
            
            if (examples[example]) {
                dpdEditor.setValue(examples[example]);
            }
        }
    </script>
    <script>
        // üìä REAL MESSAGE TRACKING FUNCTION
        function trackMessage() {
            if (!window.messageTracker) {
                window.messageTracker = { count: 0, lastReset: Date.now(), messagesPerSec: 0 };
            }
            window.messageTracker.count++;
        }
    </script>
</body>
</html>
